---
title: "The Most Expensive and Deadliest Weather Events in the United States, 1950-2011"
author: "apyle@github.com"
date: "2015-09-16"
output: 
  html_document:
    keep_md: true
---

<br />
<hr />

## Synopsis

Answer these two questions:

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?
1. Across the United States, which types of events have the greatest economic consequences?

<br />
<hr />

## Data

Actual dollars, not adjusted for inflation
<br />
<hr />

## Data Processing

```{r setoptions, echo = TRUE}
# keep the chatter down so the write-up stays clean
options(warn = -1)

# make sure we have access to the knitr library for setup and housekeeping
# suppressWarnings should not be necessary since we have used the warn option
# but using it to reinforce the idea that we want to keep the write-up clean.
suppressWarnings(library(knitr))

# use data.table for ease of storage
suppressWarnings(library(data.table))

# use dplyr for data manipulation
suppressWarnings(library(dplyr))

# set knitr default option values, specifically echo, turning on the cache and
# setting its location, and specifying the figure directory
opts_chunk$set(echo = TRUE, 
               cache = TRUE, 
               cache.path = "cache/", 
               fig.path = "figure/")
```

<br />
<hr />

```{r}

# We only need the injury and fatality counts to answer the first question and the 
# property and crop damage for the second question. This will allow us to not load 
# the values we don't need, saving memory and processing time
col_classes <- c("NULL", "NULL", "NULL", "NULL", "NULL", "NULL", "NULL", 
                 "character", "NULL", "NULL", "NULL", "NULL", "NULL", "NULL", 
                 "NULL", "NULL", "NULL", "NULL", "NULL", "NULL", "NULL", "NULL", 
                 "numeric", "numeric", "numeric", "factor", "numeric", "factor", 
                 "NULL", "NULL", "NULL", "NULL", "NULL", "NULL", "NULL", "NULL", 
                 "numeric")
storm.file <- bzfile("repdata_data_StormData.csv.bz2")
storm.data <- data.table(read.csv(storm.file, colClasses = col_classes))

# most event entries do not have any reported fatalities, injuries, or damages. Filter those out
storm.subset <- storm.data[!(FATALITIES == 0 & INJURIES == 0 & PROPDMG == 0 & CROPDMG == 0), ]

# Just for sanity checks. Not really needed for analysis
my.factor <- as.factor(storm.data$EVTYPE)
summary(my.factor)
levels(my.factor)

```

There are 48 weather events categorized by NOAA. The input data has 985. In order 
to analyze the data and find the most dangerous and expensive events we much 
clean up the `EVTYPE` field in the input file. This applies to answering both 
questions.

```{r}

# these are NOAA's weather events. Use this list to clean up the values found in the input file
event.list <- c(
              "Astronomical Low Tide", "Avalanche", "Blizzard", "Coastal Flood", 
                "Cold/Wind Chill", "Debris Flow", "Dense Fog", "Dense Smoke", 
                "Drought", "Dust Devil", "Dust Storm", "Excessive Heat", 
                "Extreme Cold/Wind Chill", "Flash Flood", "Flood", "Freezing Fog",
                "Frost/Freeze", "Funnel Cloud", "Hail", "Heat", 
                "Heavy Rain", "Heavy Snow", "High Surf", "High Wind", 
                "Hurricane/Typhoon", "Ice Storm", "Lakeshore Flood", "Lake-Effect Snow",
                "Lightning", "Marine Hail", "Marine High Wind", "Marine Strong Wind",
                "Marine Thunderstorm Wind", "Rip Current", "Seiche", "Sleet", 
                "Storm Tide", "Strong Wind", "Thunderstorm Wind", "Tornado", 
                "Tropical Depression", "Tropical Storm", "Tsunami", "Volcanic Ash", 
                "Waterspout", "Wildfire", "Winter Storm", "Winter Weather")
event.list <- data.table(event.list)
event.list <- mutate(event.list, search = toupper(event.list))
setkey(event.list, search)

# add a variable in our data set to store the cleaned up version of the event type
storm.subset <- mutate(storm.subset, search = toupper(EVTYPE))
setkey(storm.subset, search)

storm.set1 <- left_join(storm.subset, event.list, by = c("search" = "search"))

# how many are matched with good EVTYPE values?
records.total <- count(storm.set1)
records.unmatched <- sum(is.na(storm.set1$event.list))
records.matched <- sum(!is.na(storm.set1$event.list))
records.ratio <- round(records.matched / records.total, 3)
```

There are a total of `r records.total` records of which we have matched `r records.matched` for a total of `r records.ratio * 100`%.

```{r}
#
## most of the records were coded with the correct EVTYPE, i.e., the ones in the NOAA weather event list.
## Now we need to clean up as many of the incorrectly coded EVTYPEs
#storm.set1$search <- ifelse(storm.set1$EVTYPE == "THUNDERSTORM WINDS", "THUNDERSTORM WIND", storm.set1$EVTYPE)
#storm.set1$event.list <- ifelse(storm.set1$EVTYPE == "THUNDERSTORM WINDS", "Thunderstorm Wind", 
#                                ifelse(is.na(storm.set1$EVTYPE), NA, storm.set1$EVTYPE)
#                                )
#
## what's the impact of this matching?
#records.unmatched <- sum(is.na(storm.set1$event.list))
#records.matched <- sum(!is.na(storm.set1$event.list))
#records.ratio <- round(records.matched / records.total, 3)
```

There are a total of `r records.total` records of which we have matched `r records.matched` for a total of `r records.ratio * 100`%.

```{r}
#my.tmp <- grep("MARINE TSTM WIND", storm.set1$EVTYPE)
#storm.set1$search[my.tmp ] <- "MARINE THUNDERSTORM WIND"
#storm.set1$event.list[my.tmp ] <- "Marine Thunderstorm Wind"
#
## but not grep("TSTM WIND", storm.set1$EVTYPE)
#my.tmp <- storm.set1[(is.na(storm.set1$event.list) & storm.set1$EVTYPE == "TSTM WIND")]
#
#
#sum(is.na(storm.set1$event.list))
#sum(!is.na(storm.set1$event.list))
```

## Results

```{r dangerous}
# assemble the reporting data structure from the cleaned up data

# first, assemble the reporting data for dangerous weather events
by_event <- group_by(storm.set1, event.list)
dangerous <- summarize(by_event, sum(FATALITIES), sum(INJURIES))
setnames(dangerous, 1:3, c("Weather Event", "Deaths", "Injuries"))
dangerous <- mutate(dangerous, Total = Deaths + Injuries) %>% mutate(rev.sort = 100000 - Total)
setkey(dangerous, rev.sort)

dangerous[1:50, ]
#summarize(dangerous$Total)
```
<br />
<hr />

```{r costly}
# assemble the reporting data for weather event costs

```

## Conclusion

